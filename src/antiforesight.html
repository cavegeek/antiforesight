<!DOCTYPE html>
<meta charset="UTF-8">
<!-- (c) 2018 Jason Stumpf -->
<title>Anti-Foresight</title>
<style>
  body {
    margin: 0;
    padding: 0;
    overflow: hidden;
  }
  div {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
  }
  svg {
    display: block;
    margin: auto;
    max-height: 100%;
  }
</style>
<script>

'use strict';

const board = {x: 30, y: 30};

let player = {
  x: 3,
  y: 5,
  dx: 1
};

let blocks = {}; // as an associative array

function svgElem(tag) {
  return document.createElementNS("http://www.w3.org/2000/svg", tag);
}

function block(x, y) {
  let block = svgElem("use");
  block.setAttribute("href", "#block");
  block.setAttribute("x", x);
  block.setAttribute("y", y);
  document.getElementById('sprites').appendChild(block);
  blocks[[x,y]] = true;
}

function genFloors() {
  for(let i = 0; i < 20; ++i) {
    let y = Math.floor(Math.random()*board.y/3)*3;
    let start = Math.floor(Math.random()*board.x);
    let end = Math.min(start + Math.random()*8, board.x);
    for(let x = start; x < end; ++x) {
      block(x,y);
    }
  }
}

function init() {
  genFloors();

  toPlayer('x', player.x);
  toPlayer('y', player.y);

  document.addEventListener('keydown', move);
  document.getElementById('image').focus();
}

function horizontal(x, dx) {
  const m = document.getElementById('horizontal');
  m.setAttribute('from', x);
  m.setAttribute('to', x+dx);
  m.beginElement();
}

function vertical(y, dy) {
  const m = document.getElementById('vertical');
  m.setAttribute('from', y);
  m.setAttribute('to', y+dy);
  m.beginElement();
}

function toPlayer(attribute, value) {
  document.getElementById('player').setAttribute(attribute, value);
}

function nextX() {
  const x = player.x;
  const dx = player.dx
  const y = player.y;
  if(!blocks[[x+dx, y]] && !blocks[[x+dx, y-1]]) {
    horizontal(x, dx);
    player.x = x+dx;
  } else {
    horizontal(x, 0);
    player.dx = 0;
  }
  toPlayer('x', player.x);
}

function nextY() {
  const x = player.x;
  const y = player.y;
  if(!blocks[[x, y+1]]) {
    vertical(y, 1);
    player.y = y+1;
  } else {
    vertical(0);
  }
  toPlayer('y', player.y);
}

function move(event) {
  const m = document.getElementById('horizontal');
  switch(event.code) {
    case 'Space':
      nextX();
      nextY();
    break;
    case 'ArrowRight':
      player.dx = 1;
    break;
    case 'ArrowLeft':
      player.dx = -1;
    break;
  }
}

window.onload = init;
</script>
<div>
<svg id="image"
     viewBox="0 0 30 30"
     xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="sky_grad" x1="0" x2="0.1" y1="0" y2="1">
      <stop offset="0%" stop-color="#202" />
      <stop offset="50%" stop-color="#40B" />
      <stop offset="90%" stop-color="#00C" />
      <stop offset="100%" stop-color="#147" />
    </linearGradient>
    <filter id="block_turb" filterUnits="objectBoundingBox" x="0" y="0" width="1" height="1">
      <feTurbulence id="turb" type="fractalNoise" baseFrequency="2 3" numOctaves="4" />
      <feComposite in="SourceGraphic" operator="atop" />
    </filter>
    <g id="block">
      <rect x="0" y="0" width="1" height="1" fill="#FA8" />
      <rect x="0" y="0" width="1" height="1" fill="#A00" filter="url(#block_turb") />
      <rect x="0" y="0" width="1" height="1" stroke="black" stroke-width="0.1" fill="none"/>
    </g>
    <g id="player_sprite">
      <ellipse cx="0.5" cy="0" rx="0.5" ry="1" fill="green" />
    </g>
  </defs>
  <rect id="bg" x="0" y="0" width="30" height="30" fill="url(#sky_grad)" />
  <g id="sprites">
  </g>
  <use id="player" href="#player_sprite">
    <animate id="horizontal" attributeName="x" begin="beginEvent" dur="0.25" onend="nextX()" />
    <animate id="vertical" attributeName="y" begin="beginEvent" dur="0.25" onend="nextY()" />
  </use>
</svg>
</div>
